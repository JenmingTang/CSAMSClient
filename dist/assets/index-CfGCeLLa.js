import{_ as Te,a as ke,b as Ne,c as xe,d as Ce,N as Se,e as Ie}from"./round-refresh-B7VpfLgK.js";import{u as Ae,a as Ue,b as re,w as $e,_ as Be}from"./table-Gm6yRvUm.js";import{d as de,M as pe,N as _e,a as z,r as Z,O as De,o as g,c as h,w as a,f as t,h as l,B as w,g as k,t as oe,$ as N,P as T,Q as ge,s as ye,R as Le,S as Re,X as Ee,J as be,z as Pe,b as Oe,U as ne,V as Fe,W as Ve}from"./index-D6W6_zXP.js";import{h as ze,j as We,k as fe,l as Me,m as Ye}from"./activity-C6741kjc.js";import{u as ce}from"./auth-DdtuPNda.js";import{u as je,_ as He,b as he}from"./form-a8uLA4Rd.js";import{d as Ke,s as Xe,_ as Ge}from"./file-CILs5gq_.js";import{s as qe}from"./club-9izwOJFE.js";import{_ as Je}from"./DatePicker-CeSQ1aZs.js";import{_ as me}from"./Space-zKntJrGG.js";import{_ as Qe}from"./Grid-Cxuy6_wU.js";import{_ as Ze}from"./DataTable-BesTDHU0.js";import"./Pagination-BQ2WJ-Rm.js";import"./get-slot-Bk_rJcZu.js";const et=de({name:"RoleOperateDrawer",__name:"role-operate-drawer",props:pe({operateType:{},rowData:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:pe(["submitted"],["update:visible"]),setup(A,{emit:B}){const x=A,E=B,m=_e(A,"visible"),{formRef:P,validate:W,restoreValidation:M}=je(),X=z(()=>({add:"新增活动",edit:"编辑活动"})[x.operateType]),n=Z(C());function C(){return{clubId:null,title:"",content:"",location:"",startTime:null,endTime:null,approvalStatus:null,approveReason:""}}const y=z(()=>{var s;return((s=x.rowData)==null?void 0:s.id)||-1}),v=z(()=>x.operateType==="edit");function G(){n.value=C(),x.operateType==="edit"&&x.rowData&&Object.assign(n.value,x.rowData)}function O(){m.value=!1}function q(s,e){var $;let u=!1;const p=($=window.$notification)==null?void 0:$.create({title:s,content:e,action:()=>Ee(w,{text:!0,type:"primary",onClick:()=>{u=!0,p.destroy()}},{default:()=>"已读"}),onClose:()=>{var I;if(!u)return(I=window.$message)==null||I.warning("请设为已读"),!1}})}async function J(){var e;await W(),delete n.value.index,delete n.value.clubName,delete n.value.approverName;const s=await We(n.value);if(console.log("res: ",s),s.data===!0)(e=window.$message)==null||e.success(N("common.updateSuccess"));else{let u="";s.data.forEach(p=>{u+=`${p.location} ( ${p.startTime} - ${p.endTime} )
`}),q("活动场地使用冲突，请绕开！",u)}O(),E("submitted")}const b=`${String(localStorage.getItem("SOY_token")).trim().replace(/"/g,"")}`,Y=localStorage.getItem("baseUri"),S=Z([]),D=Z([]),L=Z([]),f=Z([]),F=`${Y}/upload`,ee=z(()=>({targetType:2,targetId:y.value,fileCategory:1})),se=z(()=>({targetType:2,targetId:y.value,fileCategory:2})),ie=z(()=>({targetType:2,targetId:y.value,fileCategory:3})),i=z(()=>({targetType:2,targetId:y.value,fileCategory:4})),o=async s=>{var I,V,H,ae,K,le;console.log("options: ",s);const e=await Ke(s.file.id);console.log("res: ",e);const{code:u,data:p,msg:$}=e.response.data;return u===200?((V=(I=window.$message)==null?void 0:I.success)==null||V.call(I,$),!0):u!==200?((ae=(H=window.$message)==null?void 0:H.error)==null||ae.call(H,$),!1):((le=(K=window.$message)==null?void 0:K.error)==null||le.call(K,"前端删除文件错误，请联系管理员！"),!1)},r=()=>{S.value=[],D.value=[],L.value=[],f.value=[]},_=()=>{Xe({targetId:y.value}).then(s=>{(Array.isArray(s.data)?s.data:[]).forEach(u=>{const p={id:u.id,name:u.fileName,status:"finished",url:`${Y}/${u.fileUri}`};switch(u.fileCategory){case 1:S.value.push(p);break;case 2:D.value.push(p);break;case 3:L.value.push(p);break;case 4:f.value.push(p);break;default:console.warn(`Unknown file category: ${u.fileCategory}`)}}),console.log("Mapped files:",S.value),console.log("Is array:",Array.isArray(S.value))})},R=({file:s})=>(console.log("onFinish",s),setTimeout(()=>{r(),_()},500),s);function j(s,e){const u=document.createElement("a");u.href=s,u.target="_blank",u.download=e,document.body.appendChild(u),u.click(),document.body.removeChild(u)}const U=s=>(j(s.url,s.name),!1);De(m,()=>{m.value&&(G(),M(),setTimeout(()=>{r(),_()},500))});const c=[],Q=[{label:"待审批",value:0},{label:"审批通过",value:1},{label:"审批拒绝",value:2}];qe().then(s=>{c.push(...s.data.map(e=>({label:e.name,value:e.id})))});const te=[];ze().then(s=>{te.push(...s.data.map(e=>e.approvalStatus===0||e.approvalStatus===2?{label:`${e.name}（待审批）`,value:e.name,disabled:!0}:e.approvalStatus===2?{label:`${e.name}（审批拒绝）`,value:e.name,disabled:!0}:{label:e.name,value:e.name}))});const we=()=>{window.open("https://uutool.cn/tinymce/","_blank")},{hasAuth:ve}=ce();return(s,e)=>{const u=ge,p=He,$=ye,I=Je,V=Ge,H=he,ae=me,K=Le,le=Re;return g(),h(le,{show:m.value,"onUpdate:show":e[12]||(e[12]=d=>m.value=d),"display-directive":"show",width:360},{default:a(()=>[t(K,{title:X.value,"native-scrollbar":!1,closable:""},{footer:a(()=>[t(ae,{size:16},{default:a(()=>[t(l(w),{onClick:O},{default:a(()=>[k(oe(l(N)("common.cancel")),1)]),_:1}),t(l(w),{type:"primary",onClick:J},{default:a(()=>[k(oe(l(N)("common.confirm")),1)]),_:1})]),_:1})]),default:a(()=>[t(H,{ref_key:"formRef",ref:P,model:n.value},{default:a(()=>[v.value?T("",!0):(g(),h(p,{key:0,label:"所属社团"},{default:a(()=>[t(u,{value:n.value.clubId,"onUpdate:value":e[0]||(e[0]=d=>n.value.clubId=d),options:c,clearable:""},null,8,["value"])]),_:1})),t(p,{label:"活动名称"},{default:a(()=>[t($,{value:n.value.title,"onUpdate:value":e[1]||(e[1]=d=>n.value.title=d)},null,8,["value"])]),_:1}),t(p,{label:"内容"},{default:a(()=>[t($,{value:n.value.content,"onUpdate:value":e[2]||(e[2]=d=>n.value.content=d),type:"textarea"},null,8,["value"])]),_:1}),t(p,{label:"位置"},{default:a(()=>[t(u,{value:n.value.location,"onUpdate:value":e[3]||(e[3]=d=>n.value.location=d),options:te,clearable:""},null,8,["value"])]),_:1}),t(p,{label:"开始时间"},{default:a(()=>[t(I,{value:n.value.startTime,"onUpdate:value":e[4]||(e[4]=d=>n.value.startTime=d),type:"datetime",clearable:""},null,8,["value"])]),_:1}),t(p,{label:"结束时间"},{default:a(()=>[t(I,{value:n.value.endTime,"onUpdate:value":e[5]||(e[5]=d=>n.value.endTime=d),type:"datetime",clearable:""},null,8,["value"])]),_:1}),v.value?(g(),h(p,{key:1,label:"图片"},{default:a(()=>[t(V,{"file-list":S.value,"onUpdate:fileList":e[6]||(e[6]=d=>S.value=d),action:F,data:ee.value,"list-type":"image-card","show-download-button":!0,max:9,name:"file",multiple:!0,accept:".jpg,.jpeg,.png",headers:{Authorization:`Bearer ${b}`},"on-finish":R,"on-remove":o,"on-download":U},{default:a(()=>[t(l(w),null,{default:a(()=>e[13]||(e[13]=[k("点击上传")])),_:1})]),_:1},8,["file-list","data","headers"])]),_:1})):T("",!0),v.value?(g(),h(p,{key:2,label:"附件"},{default:a(()=>[t(V,{"file-list":D.value,"onUpdate:fileList":e[7]||(e[7]=d=>D.value=d),action:F,data:se.value,"show-download-button":!0,max:9,name:"file",multiple:!0,accept:".et,.wps,.dps,.txt,.pdf,.docx,.doc,.xlsx,.xls,.csv,.pptx,.ppt,.rar,.zip,.7z,.tar,.gz",headers:{Authorization:`Bearer ${b}`},"on-finish":R,"on-remove":o,"on-download":U},{default:a(()=>[t(l(w),null,{default:a(()=>e[14]||(e[14]=[k("点击上传")])),_:1})]),_:1},8,["file-list","data","headers"])]),_:1})):T("",!0),v.value?(g(),h(p,{key:3,label:"新闻稿编写工具"},{default:a(()=>[t(l(w),{type:"primary",dashed:"",onClick:we},{default:a(()=>e[15]||(e[15]=[k("点击访问")])),_:1})]),_:1})):T("",!0),v.value?(g(),h(p,{key:4,label:"新闻稿"},{default:a(()=>[t(V,{"file-list":L.value,"onUpdate:fileList":e[8]||(e[8]=d=>L.value=d),action:F,data:ie.value,"show-download-button":!0,max:9,name:"file",multiple:!0,accept:".html,.htm",headers:{Authorization:`Bearer ${b}`},"on-remove":o,"on-finish":R,"on-download":U},{default:a(()=>[t(l(w),null,{default:a(()=>e[16]||(e[16]=[k("点击上传")])),_:1})]),_:1},8,["file-list","data","headers"])]),_:1})):T("",!0),v.value?(g(),h(p,{key:5,label:"展示新闻稿"},{default:a(()=>[t(V,{"file-list":f.value,"onUpdate:fileList":e[9]||(e[9]=d=>f.value=d),action:F,data:i.value,"show-download-button":!0,max:1,name:"file",multiple:!0,accept:".html,.htm",headers:{Authorization:`Bearer ${b}`},"on-remove":o,"on-finish":R,"on-download":U},{default:a(()=>[t(l(w),null,{default:a(()=>e[17]||(e[17]=[k("点击上传")])),_:1})]),_:1},8,["file-list","data","headers"])]),_:1})):T("",!0),v.value&&l(ve)("BUTTON_APPROVE_ACTIVITY")?(g(),h(p,{key:6,label:"审批状态"},{default:a(()=>[t(u,{value:n.value.approvalStatus,"onUpdate:value":e[10]||(e[10]=d=>n.value.approvalStatus=d),options:Q,clearable:""},null,8,["value"])]),_:1})):T("",!0),v.value&&l(ve)("BUTTON_APPROVE_ACTIVITY")?(g(),h(p,{key:7,label:"审批原因"},{default:a(()=>[t($,{value:n.value.approveReason,"onUpdate:value":e[11]||(e[11]=d=>n.value.approveReason=d),type:"textarea"},null,8,["value"])]),_:1})):T("",!0)]),_:1},8,["model"])]),_:1},8,["title"])]),_:1},8,["show"])}}}),tt=de({name:"RoleSearch",__name:"role-search",props:{model:{required:!0},modelModifiers:{}},emits:pe(["reset","search"],["update:model"]),setup(A,{emit:B}){const{hasAuth:x}=ce(),E=B,m=_e(A,"model");function P(){E("reset")}function W(){E("search")}const M=[{label:"待审批",value:"0"},{label:"审批通过",value:"1"},{label:"审批拒绝",value:"2"}];return(X,n)=>{const C=ye,y=Te,v=ge,G=ke,O=w,q=Ne,J=me,b=Qe,Y=he,S=xe,D=Ce,L=be;return g(),h(L,{bordered:!1,size:"small",class:"card-wrapper"},{default:a(()=>[t(D,{"default-expanded-names":["role-search"]},{default:a(()=>[t(S,{title:l(N)("common.search"),name:"role-search"},{default:a(()=>[t(Y,{model:m.value,"label-placement":"left","label-width":80},{default:a(()=>[t(b,{responsive:"screen","item-responsive":""},{default:a(()=>[t(y,{span:"24 s:12 m:6",label:"活动名称",path:"realName",class:"pr-24px"},{default:a(()=>[t(C,{value:m.value.title,"onUpdate:value":n[0]||(n[0]=f=>m.value.title=f)},null,8,["value"])]),_:1}),t(y,{span:"24 s:12 m:6",label:"所属社团",path:"realName",class:"pr-24px"},{default:a(()=>[t(C,{value:m.value.clubName,"onUpdate:value":n[1]||(n[1]=f=>m.value.clubName=f)},null,8,["value"])]),_:1}),t(y,{span:"24 s:12 m:6",label:"审批状态",path:"enabled",class:"pr-24px"},{default:a(()=>[t(v,{value:m.value.approvalStatus,"onUpdate:value":n[2]||(n[2]=f=>m.value.approvalStatus=f),options:M,clearable:""},null,8,["value"])]),_:1}),t(y,{span:"24 s:12 m:6",label:"审批人",path:"realName",class:"pr-24px"},{default:a(()=>[t(C,{value:m.value.approverName,"onUpdate:value":n[3]||(n[3]=f=>m.value.approverName=f)},null,8,["value"])]),_:1}),t(y,{span:"24 s:12 m:6"},{default:a(()=>[t(J,{class:"w-full",justify:"end"},{default:a(()=>[t(O,{onClick:P},{icon:a(()=>[t(G,{class:"text-icon"})]),default:a(()=>[k(" "+oe(l(N)("common.reset")),1)]),_:1}),l(x)("BUTTON_SEARCH_ACTIVITY")?(g(),h(O,{key:0,type:"primary",ghost:"",onClick:W},{icon:a(()=>[t(q,{class:"text-icon"})]),default:a(()=>[k(" "+oe(l(N)("common.search")),1)]),_:1})):T("",!0)]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["title"])]),_:1})]),_:1})}}}),at={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function ue(A){return typeof A=="function"||Object.prototype.toString.call(A)==="[object Object]"&&!Ve(A)}const gt=de({name:"activity_activity",__name:"index",setup(A){const{hasAuth:B}=ce(),x=Pe(),{columns:E,columnChecks:m,data:P,loading:W,getData:M,getDataByPage:X,mobilePagination:n,searchParams:C,resetSearchParams:y}=Ae({apiFn:fe,apiParams:{current:1,size:10,approvalStatus:null,approveReason:null,approverId:null,approveTime:null,createTime:null,updateTime:null,id:null,title:null,content:null,clubId:null,location:null,startTime:null,endTime:null,clubName:null,approverName:null},columns:()=>[{type:"selection",align:"center",width:48},{key:"index",title:N("common.index"),width:64,align:"center"},{key:"title",title:"活动名称",align:"center",minWidth:120},{key:"content",title:"内容",align:"center",minWidth:120},{key:"clubName",title:"所属社团",align:"center",minWidth:120},{key:"location",title:"位置",align:"center",minWidth:120},{key:"startTime",title:"开始时间",align:"center",minWidth:120},{key:"endTime",title:"结束时间",align:"center",minWidth:120},{key:"createTime",title:"创建时间",align:"center",minWidth:120},{key:"approvalStatus",title:"审批状态",align:"center",minWidth:120,render:i=>{if(i.approvalStatus===null)return null;const o={1:"success",0:"warning",2:"error"};let r;return i.approvalStatus===0&&(r="待审批"),i.approvalStatus===1&&(r="审批通过"),i.approvalStatus===2&&(r="审批拒绝"),t(Fe,{type:o[i.approvalStatus]},ue(r)?r:{default:()=>[r]})}},{key:"approverName",title:"审批人",align:"center",minWidth:120},{key:"approveTime",title:"审批时间",align:"center",minWidth:120},{key:"approveReason",title:"审批原因",align:"center",minWidth:120},{key:"operate",title:N("common.operate"),align:"center",width:130,render:i=>{let o;return t("div",{class:"flex-center gap-8px"},[B("BUTTON_EDIT_ACTIVITY")?t(w,{type:"primary",ghost:!0,size:"small",onClick:()=>f(i.id)},ue(o=N("common.edit"))?o:{default:()=>[o]}):null,B("BUTTON_DELETE_ACTIVITY")&&t(Se,{onPositiveClick:()=>L(i.id)},{default:()=>N("common.confirmDelete"),trigger:()=>{let r;return t(w,{type:"error",ghost:!0,size:"small"},ue(r=N("common.delete"))?r:{default:()=>[r]})}})])}}]}),{drawerVisible:v,operateType:G,editingData:O,handleAdd:q,handleEdit:J,checkedRowKeys:b,onBatchDeleted:Y,onDeleted:S}=Ue(P,M);async function D(){console.log(b.value),await Me(b.value),Y()}async function L(i){console.log(i),await Ye(i),S()}function f(i){J(i)}async function F(i,o){const r=E.value.slice(2);let _=[];i?_=(await fe({size:999999})).data.records.map(Q=>r.map(te=>ee(te,Q))):_=P.value.map(c=>r.map(Q=>ee(Q,c)));const R=r.map(c=>ie(c)&&c.title||null);_.unshift(R);const j=re.book_new(),U=re.aoa_to_sheet(_);U["!cols"]=r.map(c=>({width:Math.round(Number(c.width)/10||20)})),re.book_append_sheet(j,U,"活动列表"),$e(j,"活动数据.xlsx")}function ee(i,o){if(!se(i))return null;const{key:r}=i;if(r==="operate")return null;if(r==="approvalStatus"){let _;return o.approvalStatus===0&&(_="待审批"),o.approvalStatus===1&&(_="审批通过"),o.approvalStatus===2&&(_="审批拒绝"),_}return o[r]}function se(i){return!!i.key}function ie(i){return!!i.title}return(i,o)=>{const r=Be,_=Ie,R=me,j=Ze,U=be;return g(),Oe("div",at,[t(tt,{model:l(C),"onUpdate:model":o[0]||(o[0]=c=>ne(C)?C.value=c:null),onReset:l(y),onSearch:l(X)},null,8,["model","onReset","onSearch"]),t(U,{title:"活动列表",bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{"header-extra":a(()=>[t(R,{align:"end",wrap:"",justify:"end",class:"lt-sm:w-200px"},{default:a(()=>[l(B)("BUTTON_EXCEL_ACTIVITY")?(g(),h(l(w),{key:0,size:"small",ghost:"",type:"primary",onClick:o[1]||(o[1]=c=>F(!1))},{icon:a(()=>[t(r,{class:"text-icon"})]),default:a(()=>[o[6]||(o[6]=k(" 导出excel "))]),_:1})):T("",!0),l(B)("BUTTON_EXCEL_ACTIVITY_ALL")?(g(),h(l(w),{key:1,size:"small",ghost:"",type:"primary",onClick:o[2]||(o[2]=c=>F(!0))},{icon:a(()=>[t(r,{class:"text-icon"})]),default:a(()=>[o[7]||(o[7]=k(" 导出全部 "))]),_:1})):T("",!0),t(_,{columns:l(m),"onUpdate:columns":o[3]||(o[3]=c=>ne(m)?m.value=c:null),"disabled-delete":l(b).length===0,loading:l(W),"show-add-button-str":"BUTTON_ADD_ACTIVITY","show-batch-delete-button-str":"BUTTON_BATCH_DELETE_ACTIVITY",onAdd:l(q),onDelete:D,onRefresh:l(M)},null,8,["columns","disabled-delete","loading","onAdd","onRefresh"])]),_:1})]),default:a(()=>[t(j,{"checked-row-keys":l(b),"onUpdate:checkedRowKeys":o[4]||(o[4]=c=>ne(b)?b.value=c:null),columns:l(E),data:l(P),size:"small","flex-height":!l(x).isMobile,"scroll-x":702,loading:l(W),remote:"","row-key":c=>c.id,pagination:l(n),class:"sm:h-full"},null,8,["checked-row-keys","columns","data","flex-height","loading","row-key","pagination"]),t(et,{visible:l(v),"onUpdate:visible":o[5]||(o[5]=c=>ne(v)?v.value=c:null),"operate-type":l(G),"row-data":l(O),onSubmitted:l(X)},null,8,["visible","operate-type","row-data","onSubmitted"])]),_:1})])}}});export{gt as default};
